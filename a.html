<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>five-a-side: Premier League Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      /* Animations */
      .fade-in {
        animation: fadeIn 0.5s;
      }
      .fade-out {
        animation: fadeOut 0.5s;
      }
      .slide-in {
        animation: slideIn 0.5s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      @keyframes fadeOut {
        from {
          opacity: 1;
        }
        to {
          opacity: 0;
        }
      }
      @keyframes slideIn {
        from {
          transform: translateY(-20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .pulse {
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      .blur-background {
        filter: blur(4px);
      }
      .carousel-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        margin: auto;
        overflow: hidden;
      }
      .carousel-item {
        display: none;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .carousel-item.active {
        display: block;
        opacity: 1;
      }
      .carousel-arrow {
        font-size: 2rem;
        color: #fff;
        cursor: pointer;
        user-select: none;
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
      }
      .carousel-arrow:hover {
        color: #fbbf24;
      }
      .carousel-content {
        max-width: 300px;
        margin: 0 auto;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
      }
      .instruction-title {
        font-weight: bold;
        font-size: 1.5rem;
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 0.25rem;
        text-align: center;
        width: 100%;
      }
      .instruction-text-container {
        width: 100%;
        height: 120px;
        overflow-y: auto;
        margin-top: 1rem;
      }
      .instruction-text {
        text-align: center;
        font-size: 1rem;
        line-height: 1.5;
      }
      .bg-yellow-500 {
        background-color: #fbbf24;
      }
      .bg-purple-600 {
        background-color: #9f7aea;
      }
      .bg-green-700 {
        background-color: #047857;
      }
      .bg-blue-700 {
        background-color: #1d4ed8;
      }
      .bg-red-700 {
        background-color: #b91c1c;
      }

      /* New styles for mobile buttons */
      @media (max-width: 639px) {
        #mobile-buttons {
          display: grid;
        }
        #view-high-scores-btn,
        #how-to-play-btn-desktop {
          display: none;
        }
      }
    </style>
  </head>
  <body
    class="bg-gray-900 min-h-screen flex items-center justify-center p-2 font-poppins text-gray-100 text-base sm:text-lg touch-manipulation"
  >
    <div
      id="game-container"
      class="bg-gray-800 rounded-2xl shadow-xl p-4 w-full max-w-xl sm:max-w-2xl md:max-w-3xl lg:max-w-4xl space-y-4 relative"
    >
      <div class="absolute top-4 right-4 flex space-x-2">
        <button
          id="view-high-scores-btn"
          class="bg-gray-700 hover:bg-gray-600 font-bold text-xs sm:text-sm py-2 px-2 sm:py-2 sm:px-4 rounded-lg transition duration-300 text-white"
        >
          League Table
        </button>
        <button
          id="how-to-play-btn-desktop"
          class="bg-gray-700 hover:bg-gray-600 font-bold text-xs sm:text-sm py-2 px-2 sm:py-2 sm:px-4 rounded-lg transition duration-300 text-white"
        >
          How to play
        </button>
      </div>

      <h1 class="text-5xl sm:text-5xl font-bold text-center text-white">
        five-a-side
      </h1>
      <div
        id="round-info"
        class="text-yellow-500 text-lg sm:text-xl font-semibold text-center mt-2 mb-4"
      ></div>
      <div id="letter-grid" class="mb-4"></div>
      <div
        id="mobile-buttons"
        class="hidden sm:hidden grid grid-cols-2 gap-2 mt-4"
      >
        <button
          id="view-high-scores-btn-mobile"
          class="bg-gray-700 hover:bg-gray-600 font-bold text-xs py-2 px-2 rounded-lg transition duration-300 text-white"
        >
          League Table
        </button>
        <button
          id="how-to-play-btn-mobile"
          class="bg-gray-700 hover:bg-gray-600 font-bold text-xs py-2 px-2 rounded-lg transition duration-300 text-white"
        >
          How to Play
        </button>
      </div>
      <div
        id="starting-lineup"
        class="text-center text-lg sm:text-xl font-semibold mb-4 hidden"
      >
        Your starting lineup:
      </div>
      <div id="game-info-section" class="hidden">
        <div
          id="timer-container"
          class="w-full bg-gray-700 rounded-full h-2 sm:h-3 mb-2 sm:mb-4"
        >
          <div
            id="timer-bar"
            class="bg-red-700 h-2 sm:h-3 rounded-full transition-all duration-1000 ease-linear"
            style="width: 100%"
          ></div>
        </div>
        <div
          id="game-info"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-2 mb-4"
        >
          <div
            id="timer"
            class="bg-red-700 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-white"
          >
            Time: 45s
          </div>
          <div
            id="guesses"
            class="bg-green-700 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-white"
          >
            Guesses: 3
          </div>
          <div
            id="passes"
            class="bg-blue-700 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-white"
          >
            Passes: 3
          </div>
          <div
            id="substitutions"
            class="bg-yellow-500 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-gray-900"
          >
            Subs: 5
          </div>
          <div
            id="var-hints"
            class="bg-purple-600 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-white"
          >
            VAR: 1
          </div>
          <div
            id="score"
            class="bg-gray-700 rounded-lg p-2 text-center font-bold text-sm sm:text-base text-white"
          >
            Points: 0
          </div>
        </div>
      </div>
      <div
        id="player-card"
        class="bg-gray-700 rounded-lg p-4 mb-4 shadow-inner hidden"
      >
        <div
          id="player-name"
          class="text-2xl sm:text-3xl font-bold text-center tracking-wider h-10 sm:h-12 font-mono"
        ></div>
      </div>
      <div
        id="current-team"
        class="text-center text-sm sm:text-base font-semibold mb-2 hidden"
      >
        Your current team:
      </div>
      <div id="game-controls" class="hidden justify-center space-x-2 mb-4">
        <button
          id="guess"
          class="bg-green-700 hover:bg-green-800 font-bold py-3 px-4 rounded-lg transition duration-300 text-sm sm:text-base flex-1 text-white"
        >
          Guess
        </button>
        <button
          id="pass"
          class="bg-blue-700 hover:bg-blue-800 font-bold py-3 px-4 rounded-lg transition duration-300 text-sm sm:text-base flex-1 text-white"
        >
          Pass
        </button>
        <button
          id="substitute"
          class="bg-yellow-500 hover:bg-yellow-600 font-bold py-3 px-4 rounded-lg transition duration-300 text-sm sm:text-base flex-1 text-gray-900"
        >
          Substitutions
        </button>
        <button
          id="var"
          class="bg-purple-600 hover:bg-purple-700 font-bold py-3 px-4 rounded-lg transition duration-300 text-sm sm:text-base flex-1 text-white"
        >
          VAR
        </button>
      </div>
      <button
        id="start-game"
        class="hidden w-full bg-red-700 hover:bg-red-800 font-bold py-3 px-4 rounded-lg transition duration-300 text-lg sm:text-xl text-white"
      >
        Start Game
      </button>
      <button
        id="new-game"
        class="hidden w-full bg-red-700 hover:bg-red-800 font-bold py-3 px-4 rounded-lg transition duration-300 text-lg sm:text-xl text-white"
      >
        New Game
      </button>
    </div>
    <!-- Modals -->
    <div
      id="substituteModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-4 max-w-md w-full">
        <h2 class="text-xl font-bold text-center mb-3 text-white">
          Make a change
        </h2>
        <div id="substitute-grid" class="mb-3"></div>
      </div>
    </div>

    <div
      id="guessModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-4 max-w-sm w-full">
        <h2 class="text-xl font-bold text-center mb-3 text-white">
          Guess the player name
        </h2>
        <div
          id="guess-timer"
          class="text-lg font-semibold text-center text-yellow-400 mb-3"
        >
          Time left: 10s
        </div>
        <input
          type="text"
          id="guess-input"
          placeholder="Enter player name"
          class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg mb-3 text-white"
        />
        <button
          id="submit-guess"
          class="w-full bg-green-700 hover:bg-green-800 font-bold py-2 px-4 rounded-lg transition duration-300 text-white"
        >
          Submit
        </button>
      </div>
    </div>

    <div
      id="varHintModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div
        class="bg-gray-800 rounded-lg p-4 max-w-sm w-full border-solid border-gray-600 border-4 shadow-lg"
      >
        <h2 class="text-xl font-bold text-center mb-3 text-white">Checking</h2>
        <div id="varHintText" class="text-lg text-center mb-3 text-white"></div>
        <button
          id="close-var-hint"
          class="w-full bg-purple-600 hover:bg-purple-700 font-bold py-2 px-4 rounded-lg transition duration-300 text-white"
        >
          Check complete
        </button>
      </div>
    </div>

    <div
      id="guess-popup"
      class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-yellow-500 p-3 rounded-lg shadow-lg text-center hidden text-gray-900"
    ></div>

    <div
      id="instructionsModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-center text-white mb-4">
          How to play
        </h2>
        <div class="carousel-container">
          <div class="carousel-item active">
            <div class="carousel-content">
              <p class="instruction-title bg-white text-gray-900">
                Choose Letters
              </p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  Select 1 vowel and 4 consonants for your starting lineup.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-green-700">Guess the Player</p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  Try to guess the Premier League player using your chosen
                  letters. You have 20 seconds to make a guess.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-blue-700">Passes</p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  If you're unsure, you can pass and move on to the next player.
                  You have 3 passes per game.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-yellow-500 text-gray-900">
                Substitutions
              </p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  You can make up to 5 substitutions throughout the game. Vowels
                  can only be substituted for vowels, and consonants for
                  consonants.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-purple-600">VAR</p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  You can use VAR once per game to get a hint about the player's
                  identity.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-green-700">Guesses</p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  You have 3 incorrect guesses before the game ends. Correct
                  guesses earn 1 point in rounds 1 and 2, and 3 points in round
                  3.
                </p>
              </div>
            </div>
          </div>
          <div class="carousel-item">
            <div class="carousel-content">
              <p class="instruction-title bg-red-700">Rounds</p>
              <div class="instruction-text-container">
                <p class="instruction-text">
                  There are 3 rounds: Current Premier League players, Premier
                  League legends, and forgotten Premier League stars. You have
                  45 seconds in rounds 1 and 2, and 30 seconds in round 3.
                </p>
              </div>
            </div>
          </div>
          <span
            id="prev-btn"
            class="material-icons carousel-arrow"
            style="left: 10px"
          >
            chevron_left
          </span>
          <span
            id="next-btn"
            class="material-icons carousel-arrow"
            style="right: 10px"
          >
            chevron_right
          </span>
        </div>
        <button
          id="close-instructions"
          class="w-full mt-8 bg-gray-700 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg transition duration-300 text-white"
        >
          Got it!
        </button>
      </div>
    </div>

    <!-- Updated High Scores Modal -->
    <div
      id="highScoresModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center"
    >
      <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full">
        <h2 class="text-xl font-bold text-center text-white mb-4">
          League Table
        </h2>
        <table class="w-full mb-4">
          <thead>
            <tr>
              <th class="text-left text-white">Position</th>
              <th class="text-left text-white">Points</th>
            </tr>
          </thead>
          <tbody id="highScoresTableBody"></tbody>
        </table>
        <button
          id="clear-high-scores"
          class="w-full bg-gray-700 hover:bg-gray-600 font-bold py-2 px-4 rounded-lg transition duration-300 text-white mb-2"
        >
          Start new season (clear high scores)
        </button>
        <button
          id="close-high-scores"
          class="w-full bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-lg transition duration-300 text-white"
        >
          Close
        </button>
      </div>
    </div>

    <script>
      // Error logging function
      function logError(error, context) {
        console.error(`Error in ${context}:`, error);
        // In a production environment, you might want to send this to a server
        // or a third-party error tracking service
      }

      const VOWELS = ["A", "E", "I", "O", "U"];
      const SUBSTITUTION_COLORS = [
        "bg-red-600",
        "bg-yellow-600",
        "bg-purple-600",
        "bg-blue-600",
        "bg-green-600",
      ];

      class GameState {
        constructor() {
          this.reset();
        }

        reset() {
          this.chosenLetters = [];
          this.availableLetters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
          this.currentPlayer = "";
          this.displayedName = "";
          this.score = 0;
          this.substitutionsLeft = 5;
          this.passesLeft = 3;
          this.varHintsLeft = 1;
          this.timeLeft = 45;
          this.currentRound = 0;
          this.timerInterval = null;
          this.usedPlayers = [];
          this.usedLetters = new Set();
          this.pendingSubstitutions = {};
          this.allChosenLetters = new Set();
          this.vowelCount = 0;
          this.substitutionColorMap = {};
          this.wrongGuesses = 0;
          this.substitutionTimeoutCount = 0;
          this.isGameOver = false;
        }
      }

      const gameState = new GameState();

      // Player data (shortened for brevity)
      const playerList = {
        modernPlayers: [
          {
            name: "ERLING HAALAND",
            hint: "Norwegian striker who broke the Premier League scoring record in his debut season",
          },
          // ... (rest of the modernPlayers data)
        ],
        legendPlayers: [
          {
            name: "ALAN SHEARER",
            hint: "All-time top scorer in the Premier League. Played for Blackburn and Newcastle",
          },
          // ... (rest of the legendPlayers data)
        ],
        obscurePlayers: [
          {
            name: "DEAN HOLDSWORTH",
            hint: "English forward who formed a prolific strike partnership with Eidur Gudjohnsen at Bolton Wanderers",
          },
          // ... (rest of the obscurePlayers data)
        ],
      };

      // DOM elements
      const letterGrid = document.getElementById("letter-grid");
      const playerNameEl = document.getElementById("player-name");
      const timerEl = document.getElementById("timer");
      const timerBar = document.getElementById("timer-bar");
      const scoreEl = document.getElementById("score");
      const substitutionsEl = document.getElementById("substitutions");
      const passesEl = document.getElementById("passes");
      const varHintsEl = document.getElementById("var-hints");
      const guessesEl = document.getElementById("guesses");
      const roundInfoEl = document.getElementById("round-info");
      const currentTeamEl = document.getElementById("current-team");
      const startingLineupEl = document.getElementById("starting-lineup");

      let varHintTimeout;
      let substituteTimeout;

      // High Scores functions
      const MAX_HIGH_SCORES = 10;

      function getHighScores() {
        try {
          const highScores =
            JSON.parse(localStorage.getItem("highScores")) || [];
          return highScores.sort((a, b) => b - a).slice(0, MAX_HIGH_SCORES);
        } catch (error) {
          logError(error, "getHighScores");
          return [];
        }
      }

      function saveHighScore(score) {
        try {
          const highScores = getHighScores();
          highScores.push(score);
          highScores.sort((a, b) => b - a);
          highScores.splice(MAX_HIGH_SCORES);
          localStorage.setItem("highScores", JSON.stringify(highScores));
        } catch (error) {
          logError(error, "saveHighScore");
          showMessage("Unable to save your score. Please try again later.");
        }
      }

      function updateHighScoresTable() {
        try {
          const highScores = getHighScores();
          const tableBody = document.getElementById("highScoresTableBody");
          tableBody.innerHTML = "";

          highScores.forEach((score, index) => {
            const row = tableBody.insertRow();
            const rankCell = row.insertCell(0);
            const scoreCell = row.insertCell(1);

            rankCell.textContent = index + 1;
            scoreCell.textContent = score;

            rankCell.className = "text-white";
            scoreCell.className = "text-white";
          });
        } catch (error) {
          logError(error, "updateHighScoresTable");
          showMessage("Unable to update the high scores table.");
        }
      }

      function showHighScores() {
        try {
          const highScores = getHighScores();

          if (highScores.length === 0) {
            showMessage("Please play your first game to see the league table.");
          } else {
            updateHighScoresTable();
            openModal("highScoresModal");

            // Only show the "New Game" button if the game is over
            if (gameState.isGameOver) {
              document.getElementById("new-game").classList.remove("hidden");
            } else {
              document.getElementById("new-game").classList.add("hidden");
            }
          }
        } catch (error) {
          logError(error, "showHighScores");
          showMessage("Unable to display high scores. Please try again later.");
        }
      }

      function clearHighScores() {
        try {
          localStorage.removeItem("highScores");
          updateHighScoresTable();
          showMessage("High scores cleared!");
        } catch (error) {
          logError(error, "clearHighScores");
          showMessage("Unable to clear high scores. Please try again later.");
        }
      }

      // Game functions
      function startGame() {
        try {
          gameState.reset();
          updateScore();
          updateSubstitutions();
          updatePassDisplay();
          updateVARHints();
          updateGuesses();
          resetTimerDisplay();
          updateRoundInfo();
          playerNameEl.textContent = "";
          currentTeamEl.classList.add("hidden");
          startingLineupEl.classList.add("hidden");
          document.getElementById("player-card").classList.add("hidden");
          document.getElementById("game-info-section").classList.add("hidden");
          toggleGameControls(false);
          document.getElementById("start-game").classList.add("hidden");
          document.getElementById("new-game").classList.add("hidden");

          letterGrid.innerHTML = "";
          letterGrid.classList.remove("hidden");

          const vowelContainer = document.createElement("div");
          vowelContainer.id = "vowel-container";
          vowelContainer.classList.add("mb-4", "p-2", "rounded-lg");
          vowelContainer.innerHTML =
            "<p class='text-center mb-2 text-white font-bold'>Select 1 vowel</p><div class='grid grid-cols-5 gap-2'></div>";

          const consonantContainer = document.createElement("div");
          consonantContainer.id = "consonant-container";
          consonantContainer.innerHTML =
            "<p class='text-center mb-2 text-white font-bold'>Select 4 consonants</p><div class='grid grid-cols-4 gap-2'></div>";

          letterGrid.appendChild(vowelContainer);
          letterGrid.appendChild(consonantContainer);

          selectInitialLetters();
        } catch (error) {
          logError(error, "startGame");
          showMessage(
            "An error occurred while starting the game. Please refresh the page and try again."
          );
        }
      }

      function selectInitialLetters() {
        try {
          const vowelGrid = document.querySelector("#vowel-container .grid");
          const consonantGrid = document.querySelector(
            "#consonant-container .grid"
          );
          vowelGrid.innerHTML = "";
          consonantGrid.innerHTML = "";

          gameState.availableLetters.forEach((letter) => {
            const button = document.createElement("button");
            button.textContent = letter;
            button.classList.add(
              "letter-btn",
              "bg-blue-600",
              "hover:bg-blue-500",
              "text-white",
              "font-bold",
              "py-2",
              "px-4",
              "rounded-lg",
              "transition",
              "duration-300",
              "text-lg",
              "sm:text-xl"
            );
            button.addEventListener("click", () =>
              toggleLetter(letter, button)
            );

            if (VOWELS.includes(letter)) {
              vowelGrid.appendChild(button);
            } else {
              consonantGrid.appendChild(button);
            }
          });

          updateStartingLineup();
        } catch (error) {
          logError(error, "selectInitialLetters");
          showMessage(
            "An error occurred while setting up the letter selection. Please refresh the page and try again."
          );
        }
      }

      function toggleLetter(letter, button) {
        try {
          const index = gameState.chosenLetters.indexOf(letter);
          const isVowel = VOWELS.includes(letter);

          if (index === -1 && gameState.chosenLetters.length < 5) {
            if (isVowel && gameState.vowelCount >= 1) {
              showMessage("You can only select one vowel!");
              return;
            }
            if (
              !isVowel &&
              gameState.chosenLetters.length - gameState.vowelCount >= 4
            ) {
              showMessage("You can only select four consonants!");
              return;
            }
            gameState.chosenLetters.push(letter);
            button.classList.remove("bg-blue-600", "hover:bg-blue-500");
            button.classList.add("bg-green-700", "hover:bg-green-800");
            if (isVowel) gameState.vowelCount++;
          } else if (index !== -1) {
            gameState.chosenLetters.splice(index, 1);
            button.classList.remove("bg-green-700", "hover:bg-green-800");
            button.classList.add("bg-blue-600", "hover:bg-blue-500");
            if (isVowel) gameState.vowelCount--;
          }
          updateStartingLineup();
          if (gameState.chosenLetters.length === 5) {
            document.getElementById("start-game").classList.remove("hidden");
          } else {
            document.getElementById("start-game").classList.add("hidden");
          }
        } catch (error) {
          logError(error, "toggleLetter");
          showMessage(
            "An error occurred while selecting letters. Please try again."
          );
        }
      }

      function updateStartingLineup() {
        try {
          startingLineupEl.textContent = `Your starting lineup: ${gameState.chosenLetters.join(
            ", "
          )}`;
          startingLineupEl.classList.remove("hidden");
        } catch (error) {
          logError(error, "updateStartingLineup");
          showMessage(
            "An error occurred while updating the starting lineup. Please refresh the page."
          );
        }
      }

      function updateCurrentTeam() {
        try {
          currentTeamEl.textContent = `Your current team: ${gameState.chosenLetters.join(
            ", "
          )}`;
        } catch (error) {
          logError(error, "updateCurrentTeam");
          showMessage(
            "An error occurred while updating the current team. Please refresh the page."
          );
        }
      }

      function startRound() {
        try {
          if (gameState.wrongGuesses >= 3) {
            endGame();
            return;
          }

          gameState.currentRound++;
          gameState.timeLeft = gameState.currentRound === 3 ? 30 : 45;
          gameState.usedPlayers = [];

          gameState.allChosenLetters.clear();
          gameState.chosenLetters.forEach((letter) =>
            gameState.allChosenLetters.add(letter.toUpperCase())
          );

          selectRandomPlayer();
          updateDisplayedName();
          startTimer();
          updateRoundInfo();
          letterGrid.classList.add("hidden");
          startingLineupEl.classList.add("hidden");
          currentTeamEl.classList.remove("hidden");
          document.getElementById("player-card").classList.remove("hidden");
          document
            .getElementById("game-info-section")
            .classList.remove("hidden");
          document.getElementById("start-game").classList.add("hidden");
          toggleGameControls(true);
          updateCurrentTeam();
          showGameInfoSection();
          updateDisplay();
        } catch (error) {
          logError(error, "startRound");
          showMessage(
            "An error occurred while starting the round. Please refresh the page and try again."
          );
        }
      }

      function updateRoundInfo() {
        try {
          if (gameState.currentRound === 0) {
            roundInfoEl.textContent =
              "Choose 5 letters for your starting lineup!";
          } else {
            let roundMessage;
            switch (gameState.currentRound) {
              case 1:
                roundMessage = "Guess the current Premier League player!";
                break;
              case 2:
                roundMessage = "Guess the Premier League legend!";
                break;
              case 3:
                roundMessage = "Guess the forgotten Premier League star!";
                break;
            }
            roundInfoEl.textContent = `Round ${gameState.currentRound}: ${roundMessage}`;
          }
        } catch (error) {
          logError(error, "updateRoundInfo");
          showMessage(
            "An error occurred while updating round information. Please refresh the page."
          );
        }
      }

      function updateDisplayedName() {
        try {
          const newDisplayedName = gameState.currentPlayer.name
            .split("")
            .map((char) =>
              char === " "
                ? " "
                : gameState.allChosenLetters.has(char.toUpperCase())
                ? `<span class="letter-reveal">${char}</span>`
                : "_"
            )
            .join("");

          if (playerNameEl.innerHTML !== newDisplayedName) {
            playerNameEl.innerHTML = newDisplayedName;
            playerNameEl
              .querySelectorAll(".letter-reveal")
              .forEach((span, index) => {
                span.style.transitionDelay = `${index * 100}ms`;
                setTimeout(() => (span.style.color = "white"), 50);
              });
          }
        } catch (error) {
          logError(error, "updateDisplayedName");
          showMessage(
            "An error occurred while updating the displayed name. Please refresh the page."
          );
        }
      }

      function startTimer() {
        try {
          clearInterval(gameState.timerInterval);
          gameState.timerInterval = setInterval(() => {
            gameState.timeLeft--;
            updateTimerDisplay();
            if (gameState.timeLeft <= 0) {
              clearInterval(gameState.timerInterval);
              if (gameState.currentRound < 3) {
                startRound();
              } else {
                endGame();
              }
            }
          }, 1000);
        } catch (error) {
          logError(error, "startTimer");
          showMessage(
            "An error occurred with the game timer. Please refresh the page and try again."
          );
        }
      }

      function updateTimerDisplay() {
        try {
          timerEl.textContent = `Time: ${gameState.timeLeft}s`;
          const totalTime = gameState.currentRound === 3 ? 30 : 45;
          const percentage = (gameState.timeLeft / totalTime) * 100;
          timerBar.style.width = `${percentage}%`;
          if (gameState.timeLeft <= 10) {
            timerBar.classList.add("pulse");
          } else {
            timerBar.classList.remove("pulse");
          }
        } catch (error) {
          logError(error, "updateTimerDisplay");
          // We don't show a message here to avoid disrupting gameplay
        }
      }

      function substituteLetters() {
        try {
          if (gameState.substitutionsLeft > 0) {
            openModal("substituteModal");
            substituteTimeout = setTimeout(() => {
              gameState.substitutionTimeoutCount++;
              showMessage(
                "Hey that is enough of that time-wasting! Get on with the game!"
              );
              if (gameState.substitutionTimeoutCount >= 2) {
                gameState.substitutionsLeft = 0;
                updateSubstitutions();
                showMessage("All remaining substitutions lost!");
              }
              closeModal("substituteModal");
            }, 20000);
          } else {
            showMessage("No substitutions left!");
          }
        } catch (error) {
          logError(error, "substituteLetters");
          showMessage(
            "An error occurred while substituting letters. Please try again."
          );
        }
      }

      function showSubstituteOptions() {
        try {
          const substituteGrid = document.getElementById("substitute-grid");
          substituteGrid.innerHTML = `
            <div class="mb-4">
              <h3 class="text-lg font-bold mb-2 text-white">Select letters to substitute</h3>
              <div id="current-letters-grid" class="grid grid-cols-5 gap-2 mb-4"></div>
              <div id="available-letters-grid" class="grid grid-cols-5 gap-2"></div>
            </div>
            <button id="confirm-substitution" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-300">
              Make substitutions
            </button>
          `;

          const currentLettersGrid = document.getElementById(
            "current-letters-grid"
          );
          const availableLettersGrid = document.getElementById(
            "available-letters-grid"
          );

          gameState.chosenLetters.forEach((letter, index) => {
            const button = createLetterButton(letter, "current", index);
            currentLettersGrid.appendChild(button);
          });

          gameState.availableLetters.forEach((letter) => {
            if (
              !gameState.chosenLetters.includes(letter) &&
              !gameState.usedLetters.has(letter)
            ) {
              const button = createLetterButton(letter, "available");
              availableLettersGrid.appendChild(button);
            }
          });

          document
            .getElementById("confirm-substitution")
            .addEventListener("click", confirmSubstitution);
          updateAvailableLetters();

          // Reset pending substitutions when opening the modal
          gameState.pendingSubstitutions = {};
        } catch (error) {
          logError(error, "showSubstituteOptions");
          showMessage(
            "An error occurred while showing substitution options. Please try again."
          );
        }
      }

      function createLetterButton(letter, type, index) {
        try {
          const button = document.createElement("button");
          button.textContent = letter;
          button.classList.add(
            "letter-btn",
            "text-white",
            "font-bold",
            "py-4",
            "px-6",
            "rounded-lg",
            "text-2xl",
            "transition",
            "duration-300"
          );

          if (type === "current") {
            const color =
              SUBSTITUTION_COLORS[index % SUBSTITUTION_COLORS.length];
            gameState.substitutionColorMap[letter] = color;
            button.classList.add(color, `hover:${color.replace("600", "700")}`);
            button.addEventListener("click", () =>
              toggleCurrentLetter(letter, button)
            );
          } else {
            button.classList.add(
              "bg-gray-600",
              "opacity-50",
              "cursor-not-allowed"
            );
            button.addEventListener("click", () =>
              toggleAvailableLetter(letter, button)
            );
          }

          return button;
        } catch (error) {
          logError(error, "createLetterButton");
          showMessage(
            "An error occurred while creating letter buttons. Please refresh the page."
          );
          return document.createElement("button"); // Return a default button to prevent further errors
        }
      }

      function toggleCurrentLetter(letter, button) {
        try {
          if (gameState.pendingSubstitutions[letter]) {
            const color = gameState.substitutionColorMap[letter];
            delete gameState.pendingSubstitutions[letter];
            button.classList.remove(
              color,
              `hover:${color.replace("600", "700")}`
            );
            button.classList.add(color, "hover:bg-blue-500");
          } else {
            const color = gameState.substitutionColorMap[letter];
            gameState.pendingSubstitutions[letter] = null;
            button.classList.remove("bg-blue-600", "hover:bg-blue-700");
            button.classList.add(color, `hover:${color.replace("600", "700")}`);
          }
          updateAvailableLetters();
        } catch (error) {
          logError(error, "toggleCurrentLetter");
          showMessage(
            "An error occurred while selecting a letter. Please try again."
          );
        }
      }

      function toggleAvailableLetter(letter, button) {
        try {
          const isVowel = VOWELS.includes(letter);
          const correspondingCurrentLetter = Object.keys(
            gameState.pendingSubstitutions
          ).find(
            (key) =>
              gameState.pendingSubstitutions[key] === null &&
              VOWELS.includes(key) === isVowel
          );

          if (correspondingCurrentLetter) {
            const color =
              gameState.substitutionColorMap[correspondingCurrentLetter];
            if (
              gameState.pendingSubstitutions[correspondingCurrentLetter] ===
              letter
            ) {
              gameState.pendingSubstitutions[correspondingCurrentLetter] = null;
              button.classList.remove(
                color,
                `hover:${color.replace("600", "700")}`
              );
              button.classList.add(
                "bg-gray-600",
                "opacity-50",
                "cursor-not-allowed"
              );
            } else {
              gameState.pendingSubstitutions[correspondingCurrentLetter] =
                letter;
              button.classList.remove(
                "bg-gray-600",
                "opacity-50",
                "cursor-not-allowed"
              );
              button.classList.add(
                color,
                `hover:${color.replace("600", "700")}`
              );
            }
          }
          updateAvailableLetters();
        } catch (error) {
          logError(error, "toggleAvailableLetter");
          showMessage(
            "An error occurred while selecting a letter. Please try again."
          );
        }
      }

      function updateAvailableLetters() {
        try {
          const availableButtons = document.querySelectorAll(
            "#available-letters-grid .letter-btn"
          );
          const pendingVowels = Object.keys(
            gameState.pendingSubstitutions
          ).filter(
            (letter) =>
              VOWELS.includes(letter) &&
              gameState.pendingSubstitutions[letter] === null
          ).length;
          const pendingConsonants = Object.keys(
            gameState.pendingSubstitutions
          ).filter(
            (letter) =>
              !VOWELS.includes(letter) &&
              gameState.pendingSubstitutions[letter] === null
          ).length;

          availableButtons.forEach((btn) => {
            const letter = btn.textContent;
            const isSelected = Object.values(
              gameState.pendingSubstitutions
            ).includes(letter);
            const correspondingCurrentLetter = Object.keys(
              gameState.pendingSubstitutions
            ).find((key) => gameState.pendingSubstitutions[key] === letter);

            btn.classList.remove(
              ...SUBSTITUTION_COLORS,
              ...SUBSTITUTION_COLORS.map(
                (color) => `hover:${color.replace("600", "700")}`
              )
            );

            if (isSelected) {
              const color =
                gameState.substitutionColorMap[correspondingCurrentLetter];
              btn.classList.remove(
                "bg-gray-600",
                "opacity-50",
                "cursor-not-allowed"
              );
              btn.classList.add(color, `hover:${color.replace("600", "700")}`);
            } else if (
              (VOWELS.includes(letter) && pendingVowels > 0) ||
              (!VOWELS.includes(letter) && pendingConsonants > 0)
            ) {
              btn.classList.remove(
                "bg-gray-600",
                "opacity-50",
                "cursor-not-allowed"
              );
              btn.classList.add(
                "bg-green-600",
                "hover:bg-green-700",
                "cursor-pointer"
              );
            } else {
              btn.classList.remove(
                "bg-green-600",
                "hover:bg-green-700",
                "cursor-pointer"
              );
              btn.classList.add(
                "bg-gray-600",
                "opacity-50",
                "cursor-not-allowed"
              );
            }
          });
        } catch (error) {
          logError(error, "updateAvailableLetters");
          showMessage(
            "An error occurred while updating available letters. Please refresh the page."
          );
        }
      }

      function confirmSubstitution() {
        try {
          const substitutions = Object.entries(
            gameState.pendingSubstitutions
          ).filter(([_, newLetter]) => newLetter !== null);

          if (
            substitutions.length > 0 &&
            substitutions.length <= gameState.substitutionsLeft
          ) {
            substitutions.forEach(([oldLetter, newLetter]) => {
              const index = gameState.chosenLetters.indexOf(oldLetter);
              gameState.chosenLetters[index] = newLetter;
              gameState.usedLetters.add(oldLetter);
              gameState.usedLetters.add(newLetter);
              gameState.allChosenLetters.add(newLetter.toUpperCase());
            });

            gameState.substitutionsLeft -= substitutions.length;
            updateSubstitutions();
            updateCurrentTeam();
            updateDisplayedName();
            closeModal("substituteModal");
            resumeTimer();
            showSubstitutionFeedback(
              substitutions.map(([oldLetter]) => oldLetter),
              substitutions.map(([, newLetter]) => newLetter)
            );
          } else if (substitutions.length === 0) {
            showMessage("Please select new letters to substitute!");
          } else if (substitutions.length > gameState.substitutionsLeft) {
            showMessage(
              `You only have ${gameState.substitutionsLeft} substitution(s) left!`
            );
          } else {
            showMessage("An error occurred. Please try again.");
          }

          // Clear pending substitutions after processing
          gameState.pendingSubstitutions = {};
        } catch (error) {
          logError(error, "confirmSubstitution");
          showMessage(
            "An error occurred while confirming substitutions. Please try again."
          );
        }
      }

      function showSubstitutionFeedback(oldLetters, newLetters) {
        try {
          const feedbackEl = document.createElement("div");
          feedbackEl.classList.add(
            "text-center",
            "text-white",
            "my-4",
            "p-2",
            "bg-blue-600",
            "rounded"
          );
          feedbackEl.innerHTML = `Substituted: ${oldLetters.join(
            ", "
          )} ➡️ ${newLetters.join(", ")}`;
          document
            .getElementById("game-container")
            .insertBefore(feedbackEl, roundInfoEl);
          setTimeout(() => feedbackEl.remove(), 3000);
        } catch (error) {
          logError(error, "showSubstitutionFeedback");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function passPlayer() {
        try {
          if (gameState.passesLeft > 0) {
            gameState.passesLeft--;
            showPassFeedback();
            moveToNextPlayer();
          } else {
            showMessage("No passes left!");
          }
        } catch (error) {
          logError(error, "passPlayer");
          showMessage("An error occurred while passing. Please try again.");
        }
      }

      function showPassFeedback() {
        try {
          const feedbackEl = document.createElement("div");
          feedbackEl.classList.add(
            "text-center",
            "text-white",
            "my-4",
            "p-2",
            "bg-yellow-600",
            "rounded",
            "animate-fade-in-out"
          );
          feedbackEl.textContent = "That's a sideways pass! Next player...";
          document
            .getElementById("game-container")
            .insertBefore(feedbackEl, roundInfoEl);
          setTimeout(() => feedbackEl.remove(), 2000);
        } catch (error) {
          logError(error, "showPassFeedback");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function updatePassDisplay() {
        try {
          passesEl.textContent = `Passes: ${gameState.passesLeft}`;
          document.getElementById("pass").disabled = gameState.passesLeft <= 0;
        } catch (error) {
          logError(error, "updatePassDisplay");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function showVARHint() {
        try {
          if (gameState.varHintsLeft > 0) {
            gameState.varHintsLeft--;
            openModal("varHintModal");
            document.getElementById("varHintText").textContent =
              gameState.currentPlayer.hint;
            updateVARHints();
            varHintTimeout = setTimeout(() => {
              closeModal("varHintModal");
            }, 20000); // Close after 20 seconds
          } else {
            showMessage("You can't go to VAR!");
          }
        } catch (error) {
          logError(error, "showVARHint");
          showMessage(
            "An error occurred while showing the VAR hint. Please try again."
          );
        }
      }

      function updateVARHints() {
        try {
          varHintsEl.textContent = `VAR: ${gameState.varHintsLeft}`;
          document.getElementById("var").disabled = gameState.varHintsLeft <= 0;
        } catch (error) {
          logError(error, "updateVARHints");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      let guessModalTimer;
      function openGuessModal() {
        try {
          openModal("guessModal");
          let timeLeft = 20;
          updateGuessModalTimer(timeLeft);
          guessModalTimer = setInterval(() => {
            timeLeft--;
            updateGuessModalTimer(timeLeft);
            if (timeLeft <= 0) {
              clearInterval(guessModalTimer);
              processGuess();
            }
          }, 1000);

          // Set focus on the input field
          document.getElementById("guess-input").focus();
        } catch (error) {
          logError(error, "openGuessModal");
          showMessage(
            "An error occurred while opening the guess modal. Please try again."
          );
        }
      }

      function updateGuessModalTimer(time) {
        try {
          document.getElementById(
            "guess-timer"
          ).textContent = `Time left: ${time}s`;
        } catch (error) {
          logError(error, "updateGuessModalTimer");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function processGuess() {
        try {
          clearInterval(guessModalTimer);
          const guess = document
            .getElementById("guess-input")
            .value.toUpperCase()
            .trim();
          if (guess === gameState.currentPlayer.name) {
            gameState.score += gameState.currentRound === 3 ? 3 : 1;
            updateScore();
            showSuccessMessage("Correct! Well done!");
            closeModal("guessModal");
            moveToNextPlayer();
          } else {
            gameState.wrongGuesses++;
            updateGuesses();
            showIncorrectGuessPopup();
            if (gameState.wrongGuesses >= 3) {
              closeModal("guessModal");
              endGame();
              return;
            }
          }
          document.getElementById("guess-input").value = "";
          closeModal("guessModal");
        } catch (error) {
          logError(error, "processGuess");
          showMessage(
            "An error occurred while processing your guess. Please try again."
          );
        }
      }

      function moveToNextPlayer() {
        try {
          selectRandomPlayer();
          updateDisplayedName();
          updateDisplay();
        } catch (error) {
          logError(error, "moveToNextPlayer");
          showMessage(
            "An error occurred while moving to the next player. Please refresh the page."
          );
        }
      }

      function showSuccessMessage(message) {
        try {
          const popup = document.getElementById("guess-popup");
          popup.textContent = message;
          popup.classList.remove("hidden", "bg-yellow-500");
          popup.classList.add("bg-green-500", "text-white");
          setTimeout(() => {
            popup.classList.add("hidden");
          }, 2000);
        } catch (error) {
          logError(error, "showSuccessMessage");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function showIncorrectGuessPopup() {
        try {
          const popup = document.getElementById("guess-popup");
          let message;
          let color;
          switch (gameState.wrongGuesses) {
            case 1:
              message =
                "The ref wants the game to flow so that's just a warning";
              color = "bg-white text-black";
              break;
            case 2:
              message = "Oooooo, that's a booking!";
              color = "bg-yellow-500 text-black";
              break;
            case 3:
              message = "That's a shocking tackle! Get off the pitch!";
              color = "bg-red-600 text-white";
              break;
            default:
              message = "Incorrect guess!";
              color = "bg-white text-black";
          }
          popup.textContent = message;
          popup.className = `fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 p-3 rounded-lg shadow-lg text-center ${color}`;
          popup.classList.remove("hidden");
          setTimeout(() => {
            popup.classList.add("hidden");
          }, 2000);
        } catch (error) {
          logError(error, "showIncorrectGuessPopup");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function endGame() {
        try {
          clearInterval(gameState.timerInterval);
          gameState.isGameOver = true;

          // Close all modals
          closeModal("guessModal");
          closeModal("varHintModal");
          closeModal("substituteModal");

          roundInfoEl.textContent = `That's the game. You picked up: ${gameState.score} points`;
          timerEl.textContent = "Time: 0s";
          timerBar.style.width = "0%";
          guessesEl.textContent = "Guesses: 0";
          passesEl.textContent = "Passes: 0";
          substitutionsEl.textContent = "Subs: 0";
          varHintsEl.textContent = "VAR: 0";
          scoreEl.textContent = `Points: ${gameState.score}`;
          toggleGameControls(false);
          playerNameEl.textContent = "";
          currentTeamEl.classList.add("hidden");

          // Reset timer and timer bar
          gameState.timeLeft = 0;
          updateTimerDisplay();

          // Save and show high scores
          saveHighScore(gameState.score);
          showHighScores();

          // Show the "New Game" button
          document.getElementById("new-game").classList.remove("hidden");
        } catch (error) {
          logError(error, "endGame");
          showMessage(
            "An error occurred while ending the game. Please refresh the page."
          );
        }
      }

      function updateScore() {
        try {
          scoreEl.textContent = `Points: ${gameState.score}`;
        } catch (error) {
          logError(error, "updateScore");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function updateSubstitutions() {
        try {
          substitutionsEl.textContent = `Subs: ${gameState.substitutionsLeft}`;
          document.getElementById("substitute").disabled =
            gameState.substitutionsLeft <= 0;
        } catch (error) {
          logError(error, "updateSubstitutions");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function updateGuesses() {
        try {
          guessesEl.textContent = `Guesses: ${3 - gameState.wrongGuesses}`;
        } catch (error) {
          logError(error, "updateGuesses");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function toggleGameControls(show) {
        try {
          const gameControls = document.getElementById("game-controls");
          if (show) {
            gameControls.classList.remove("hidden");
            gameControls.classList.add("flex");
          } else {
            gameControls.classList.add("hidden");
            gameControls.classList.remove("flex");
          }
        } catch (error) {
          logError(error, "toggleGameControls");
          showMessage(
            "An error occurred while updating game controls. Please refresh the page."
          );
        }
      }

      function openModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          modal.classList.remove("hidden");
          modal.classList.add("flex");
          document
            .getElementById("game-container")
            .classList.add("blur-background");

          if (modalId === "guessModal") {
            document.getElementById("guess-input").value = "";
            document.getElementById("guess-timer").textContent =
              "Time left: 20s";
          } else if (modalId === "substituteModal") {
            showSubstituteOptions();
          } else if (modalId === "instructionsModal") {
            currentSlide = 0;
            showSlide(currentSlide);
          }

          // Only pause the timer if the game is in progress
          if (gameState.currentRound > 0 && !gameState.isGameOver) {
            pauseTimer();
          }
        } catch (error) {
          logError(error, "openModal");
          showMessage(
            "An error occurred while opening the modal. Please try again."
          );
        }
      }

      function closeModal(modalId) {
        try {
          const modal = document.getElementById(modalId);
          modal.classList.add("hidden");
          modal.classList.remove("flex");
          document
            .getElementById("game-container")
            .classList.remove("blur-background");

          if (modalId === "guessModal") {
            clearInterval(guessModalTimer);
          } else if (modalId === "varHintModal") {
            clearTimeout(varHintTimeout);
          } else if (modalId === "substituteModal") {
            clearTimeout(substituteTimeout);
          }

          // Only resume the timer if the game is in progress
          if (gameState.currentRound > 0 && !gameState.isGameOver) {
            resumeTimer();
          }
        } catch (error) {
          logError(error, "closeModal");
          showMessage(
            "An error occurred while closing the modal. Please try again."
          );
        }
      }

      function pauseTimer() {
        try {
          clearInterval(gameState.timerInterval);
        } catch (error) {
          logError(error, "pauseTimer");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function resumeTimer() {
        try {
          startTimer();
        } catch (error) {
          logError(error, "resumeTimer");
          showMessage(
            "An error occurred while resuming the timer. Please refresh the page."
          );
        }
      }

      function resetTimerDisplay() {
        try {
          timerEl.textContent = `Time: ${gameState.timeLeft}s`;
          timerBar.style.width = "100%";
          timerBar.classList.remove("pulse");
        } catch (error) {
          logError(error, "resetTimerDisplay");
          // Don't show a message here to avoid disrupting the game flow
        }
      }

      function showGameInfoSection() {
        try {
          document
            .getElementById("game-info-section")
            .classList.remove("hidden");
        } catch (error) {
          logError(error, "showGameInfoSection");
          showMessage(
            "An error occurred while showing game information. Please refresh the page."
          );
        }
      }

      function showMessage(message) {
        try {
          const messageEl = document.createElement("div");
          messageEl.classList.add(
            "fixed",
            "top-1/2",
            "left-1/2",
            "transform",
            "-translate-x-1/2",
            "-translate-y-1/2",
            "bg-green-600",
            "bg-green-600",
            "text-white",
            "p-4",
            "rounded",
            "text-center",
            "shadow-lg",
            "z-50"
          );
          messageEl.textContent = message;
          document.body.appendChild(messageEl);
          setTimeout(() => messageEl.remove(), 2000);
        } catch (error) {
          logError(error, "showMessage");
          console.error("Failed to show message:", message);
        }
      }

      function selectRandomPlayer() {
        try {
          const availablePlayers =
            gameState.currentRound === 1
              ? playerList.modernPlayers
              : gameState.currentRound === 2
              ? playerList.legendPlayers
              : playerList.obscurePlayers;

          const unusedPlayers = availablePlayers.filter(
            (player) => !gameState.usedPlayers.includes(player.name)
          );

          if (unusedPlayers.length === 0) {
            gameState.usedPlayers = [];
          }

          const availableUnusedPlayers = availablePlayers.filter(
            (player) => !gameState.usedPlayers.includes(player.name)
          );

          if (availableUnusedPlayers.length === 0) {
            throw new Error("No available players");
          }

          gameState.currentPlayer =
            availableUnusedPlayers[
              Math.floor(Math.random() * availableUnusedPlayers.length)
            ];

          gameState.usedPlayers.push(gameState.currentPlayer.name);
        } catch (error) {
          logError(error, "selectRandomPlayer");
          showMessage(
            "An error occurred while selecting a player. Please refresh the page."
          );
          // Fallback: select a random player from all available players
          const allPlayers = [
            ...playerList.modernPlayers,
            ...playerList.legendPlayers,
            ...playerList.obscurePlayers,
          ];
          gameState.currentPlayer =
            allPlayers[Math.floor(Math.random() * allPlayers.length)];
        }
      }

      function updateDisplay() {
        try {
          updateScore();
          updateSubstitutions();
          updatePassDisplay();
          updateVARHints();
          updateTimerDisplay();
          updateRoundInfo();
        } catch (error) {
          logError(error, "updateDisplay");
          showMessage(
            "An error occurred while updating the display. Please refresh the page."
          );
        }
      }

      // Event listeners
      document
        .getElementById("start-game")
        .addEventListener("click", startRound);
      document.getElementById("new-game").addEventListener("click", startGame);
      document
        .getElementById("guess")
        .addEventListener("click", openGuessModal);
      document.getElementById("pass").addEventListener("click", passPlayer);
      document
        .getElementById("substitute")
        .addEventListener("click", substituteLetters);
      document.getElementById("var").addEventListener("click", showVARHint);
      document
        .getElementById("submit-guess")
        .addEventListener("click", processGuess);
      document
        .getElementById("close-var-hint")
        .addEventListener("click", () => closeModal("varHintModal"));
      document
        .getElementById("close-high-scores")
        .addEventListener("click", () => closeModal("highScoresModal"));
      document
        .getElementById("view-high-scores-btn")
        .addEventListener("click", showHighScores);
      document
        .getElementById("view-high-scores-btn-mobile")
        .addEventListener("click", showHighScores);
      document
        .getElementById("clear-high-scores")
        .addEventListener("click", clearHighScores);

      document.querySelectorAll(".fixed.inset-0").forEach((modal) => {
        modal.addEventListener("click", function (event) {
          if (event.target === this) {
            closeModal(this.id);
          }
        });
      });

      document
        .getElementById("guess-input")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            processGuess();
          }
        });

      // How to Play Modal
      const howToPlayBtn = document.getElementById("how-to-play-btn-desktop");
      const howToPlayBtnMobile = document.getElementById(
        "how-to-play-btn-mobile"
      );
      const instructionsModal = document.getElementById("instructionsModal");
      const carouselItems = document.querySelectorAll(".carousel-item");
      let currentSlide = 0;

      function showSlide(index) {
        try {
          carouselItems.forEach((item, i) => {
            item.classList.toggle("active", i === index);
          });
        } catch (error) {
          logError(error, "showSlide");
          showMessage(
            "An error occurred while showing the instruction slides. Please try again."
          );
        }
      }

      document.getElementById("next-btn").addEventListener("click", () => {
        currentSlide = (currentSlide + 1) % carouselItems.length;
        showSlide(currentSlide);
      });

      document.getElementById("prev-btn").addEventListener("click", () => {
        currentSlide =
          (currentSlide - 1 + carouselItems.length) % carouselItems.length;
        showSlide(currentSlide);
      });

      howToPlayBtn.addEventListener("click", () =>
        openModal("instructionsModal")
      );
      howToPlayBtnMobile.addEventListener("click", () =>
        openModal("instructionsModal")
      );
      document
        .getElementById("close-instructions")
        .addEventListener("click", () => closeModal("instructionsModal"));

      // Initialize the game
      startGame();
    </script>
  </body>
</html>
