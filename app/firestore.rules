rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if the authenticated user owns this resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if a field exists and is a string
    function isValidString(field) {
      return field is string && field.size() > 0;
    }

    // Check if a field is a valid score (non-negative integer)
    function isValidScore(score) {
      return score is int && score >= 0;
    }

    // ==================== USER PROFILES ====================

    match /users/{userId} {
      // Users can only read their own profile
      allow read: if isOwner(userId);

      // Users can create their own profile with required fields
      allow create: if isOwner(userId)
        && isValidString(request.resource.data.displayName)
        && isValidString(request.resource.data.email)
        && request.resource.data.authProvider in ['email', 'google'];

      // Users can update their own profile (limited fields)
      allow update: if isOwner(userId)
        // Cannot change email or authProvider after creation
        && request.resource.data.email == resource.data.email
        && request.resource.data.authProvider == resource.data.authProvider
        // Cannot set stats to invalid values
        && request.resource.data.stats.totalGamesPlayed >= 0
        && request.resource.data.stats.highestScore >= 0;

      // Users can delete their own profile
      allow delete: if isOwner(userId);

      // ==================== GAME HISTORY (SUBCOLLECTION) ====================

      match /games/{gameId} {
        // Users can only read their own game history
        allow read: if isOwner(userId);

        // Users can create game records with valid data
        allow create: if isOwner(userId)
          && isValidScore(request.resource.data.score)
          && request.resource.data.endReason in ['completed', 'three-strikes', 'cheating'];

        // Game records should not be updated after creation
        allow update: if false;

        // Users can delete their own game history
        allow delete: if isOwner(userId);
      }
    }

    // ==================== PLAYERS (READ-ONLY) ====================

    match /players/{playerId} {
      // Any authenticated user can read players (needed for the game)
      allow read: if isAuthenticated();

      // Only admins can write (via Firebase console or Cloud Functions)
      allow write: if false;
    }

    // ==================== LEADERBOARD ====================

    match /leaderboard/{entryId} {
      // Anyone can read the leaderboard (it's public)
      allow read: if true;

      // Authenticated users can create entries for themselves only
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && isValidString(request.resource.data.displayName)
        && isValidScore(request.resource.data.score)
        && request.resource.data.period == 'all-time';

      // Leaderboard entries cannot be updated (immutable high scores)
      allow update: if false;

      // Users can only delete their own leaderboard entries
      allow delete: if isAuthenticated()
        && resource.data.userId == request.auth.uid;
    }

    // ==================== CHALLENGES ====================

    match /challenges/{challengeId} {
      // Check if user is participant in the challenge
      function isParticipant() {
        return isAuthenticated() && (
          resource.data.challengerId == request.auth.uid ||
          resource.data.opponentId == request.auth.uid
        );
      }

      // Check if this is a link-based challenge (no opponent yet)
      function isLinkChallenge() {
        return resource.data.opponentId == null && resource.data.inviteCode != null;
      }

      // Participants can read their challenges
      // Also allow reading link-based challenges by anyone (for join page)
      allow read: if isParticipant() || isLinkChallenge();

      // Authenticated users can create challenges where they are the challenger
      // Allow either direct challenges (with opponent) or link challenges (without opponent)
      allow create: if isAuthenticated()
        && request.resource.data.challengerId == request.auth.uid
        && isValidString(request.resource.data.challengerName)
        && request.resource.data.status == 'pending'
        // Either has opponent (direct challenge) or has invite code (link challenge)
        && (
          (isValidString(request.resource.data.opponentId) && isValidString(request.resource.data.opponentName))
          || (request.resource.data.opponentId == null && request.resource.data.inviteCode != null)
        );

      // Participants can update challenges (for accepting, submitting scores, etc.)
      // Also allow accepting link challenges (setting opponent for first time)
      allow update: if isAuthenticated() && (
        // Existing participant updating
        (isParticipant() && request.resource.data.challengerId == resource.data.challengerId)
        // OR accepting a link challenge (setting opponent for first time)
        || (isLinkChallenge()
            && request.resource.data.opponentId == request.auth.uid
            && resource.data.challengerId != request.auth.uid)
      );

      // Only challenger can delete a pending challenge
      allow delete: if isAuthenticated()
        && resource.data.challengerId == request.auth.uid
        && resource.data.status == 'pending';
    }

    // ==================== TOURNAMENTS ====================

    match /tournaments/{tournamentId} {
      // Check if user is participant
      function isTournamentParticipant() {
        return isAuthenticated() && request.auth.uid in resource.data.participantIds;
      }

      function isTournamentCreator() {
        return isAuthenticated() && resource.data.creatorId == request.auth.uid;
      }

      // Public tournaments can be read by anyone, private only by participants
      allow read: if resource.data.isPublic == true || isTournamentParticipant() || isTournamentCreator();

      // Authenticated users can create tournaments
      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid
        && isValidString(request.resource.data.name)
        && request.resource.data.type in ['knockout', 'league']
        && request.resource.data.status == 'pending';

      // Creator can update during pending, participants can update during play
      allow update: if isTournamentCreator() || isTournamentParticipant();

      // Only creator can delete (and only during pending)
      allow delete: if isTournamentCreator()
        && resource.data.status == 'pending';

      // Tournament matches subcollection
      match /matches/{matchId} {
        function isMatchParticipant() {
          return isAuthenticated() && (
            resource.data.player1Id == request.auth.uid ||
            resource.data.player2Id == request.auth.uid
          );
        }

        // Tournament participants can read all matches
        allow read: if isAuthenticated()
          && request.auth.uid in get(/databases/$(database)/documents/tournaments/$(tournamentId)).data.participantIds;

        // Match participants can update their scores
        allow update: if isMatchParticipant()
          && request.resource.data.player1Id == resource.data.player1Id
          && request.resource.data.player2Id == resource.data.player2Id;

        // No direct create/delete - handled by Cloud Functions
        allow create, delete: if false;
      }
    }

    // ==================== FRIEND GROUPS ====================

    match /groups/{groupId} {
      function isGroupMember() {
        return isAuthenticated() && request.auth.uid in resource.data.memberIds;
      }

      function isGroupCreator() {
        return isAuthenticated() && resource.data.creatorId == request.auth.uid;
      }

      // Members can read their groups
      allow read: if isGroupMember() || isGroupCreator();

      // Anyone can read by invite code (for joining)
      allow read: if isAuthenticated();

      // Authenticated users can create groups
      allow create: if isAuthenticated()
        && request.resource.data.creatorId == request.auth.uid
        && isValidString(request.resource.data.name);

      // Creator and admins can update
      allow update: if isGroupMember();

      // Only creator can delete
      allow delete: if isGroupCreator();
    }

    // ==================== PENALTY SHOOTOUTS ====================

    match /penaltyShootouts/{shootoutId} {
      function isShootoutParticipant() {
        return isAuthenticated() && (
          resource.data.challengerId == request.auth.uid ||
          resource.data.opponentId == request.auth.uid
        );
      }

      allow read: if isShootoutParticipant();
      allow create: if isAuthenticated();
      allow update: if isShootoutParticipant();
      allow delete: if false;
    }

    // ==================== USER PUBLIC PROFILES (for challenges) ====================

    match /userProfiles/{userId} {
      // Anyone can read public profile info (display name, photo)
      allow read: if isAuthenticated();

      // Users can only write their own public profile
      allow write: if isOwner(userId);
    }

    // ==================== DENY ALL OTHER ACCESS ====================

    // Catch-all: deny access to any other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
